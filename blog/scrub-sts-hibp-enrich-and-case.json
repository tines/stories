{"schema_version":1,"name":"Scrub STS HIBP Enrich and Case","description":null,"guid":"3f4251e2925ed15a2002f7fed724b41e","exported_at":"2020-07-31T09:38:06Z","agents":[{"type":"Agents::HTTPRequestAgent","name":"Create New Alert in TheHive","disabled":false,"guid":"c7887512e51a34294d3083ba74685f01","options":{"url":"http://{% global_resource thehive %}/api/alert","content_type":"json","method":"post","payload":{"title":"New Compromised Account Credentials","description":"Global Incident ID: {{ .global_incident_id.global_incident_id }}{% line_break %}\nUser/Email Account: {{ .receive_webhook_from_send_to_story.email }}{% line_break %}\nFound in breach(es): {% for element in receive_webhook_from_send_to_story.breach_names %}{{ element.Name }}{% line_break%}{% if forloop.last != true %},{% endif %}{% endfor %}{% line_break %}","type":"external","source":"HIBP via Tines","sourceRef":"{{ .global_incident_id.global_incident_id }}","severity":"3","tlp":"2"},"headers":{"Authorization":"Bearer {% credential thehive %}"}},"schedule":null,"keep_events_for":604800},{"type":"Agents::EventTransformationAgent","name":"Explode Breach Names","disabled":false,"guid":"ab1e31a2c725865e70530bc28f12a26b","options":{"mode":"explode","path":"{{.receive_webhook_from_send_to_story.breach_names }}","to":"breach_name"},"keep_events_for":604800},{"type":"Agents::TriggerAgent","name":"Trigger if TheHive Case Created","disabled":false,"guid":"817744585c7245b4f4fee848c4601b2c","options":{"rules":[{"type":"field==value","value":"201","path":"{{ .create_case_in_thehive.status }}"}]},"keep_events_for":604800},{"type":"Agents::EventTransformationAgent","name":"Throttle For HIBP API","disabled":false,"guid":"7f1cc802f7c42b32983fbdf53f6decfb","options":{"mode":"delay","seconds":"{{ .explode_breach_names.index | times: 3 }}"},"keep_events_for":604800},{"type":"Agents::EventTransformationAgent","name":"Build Results","disabled":false,"guid":"84d36ac2e029eb5599946a6d0ac57d82","options":{"mode":"message_only","global_incident_id":"{{ .global_incident_id.global_incident_id }}","breach_email":"{{ .receive_webhook_from_send_to_story.email }}","breach_summaries":"{{ .summarize_breaches.breach_summaries }}","thehive_id":"{{ .create_case_in_thehive.body.id }}","jira_id":"{{ .create_case_in_jira_service_desk.body.id }}","jira_key":"{{ .create_case_in_jira_service_desk.body.key }}","jira_link":"{{ .create_case_in_jira_service_desk.body.self }}","malicious_activity":"{{ .check_email_reputation_in_emailrep_io.body.details.malicious_activity}}","malicious_activity_recent":"{{ .check_email_reputation_in_emailrep_io.body.details.malicious_activity_recent}}","spam":"{{ .check_email_reputation_in_emailrep_io.body.details.spam}}"},"keep_events_for":604800},{"type":"Agents::WebhookAgent","name":"Receive Webhook from Send To Story","disabled":false,"guid":"6aff3ecaecdf063a33278aed56574bb2","options":{"secret":"bb436454186d1e01d7e6fe70db5dcfdb","verbs":"get,post"},"keep_events_for":604800},{"type":"Agents::EventTransformationAgent","name":"Global Incident ID","disabled":false,"guid":"500d3c1a4f77b8037fcada67723d7d5a","options":{"mode":"message_only","global_incident_id":"soar-ref-{{ \"now\" | date: '%s%L' }}"},"keep_events_for":604800},{"type":"Agents::EventTransformationAgent","name":"Implode Breach Details","disabled":false,"guid":"3b53755c545c20257829e519c25cc9fd","options":{"mode":"implode","guid_path":"{% story_run_guid %}","size_path":"{{.explode_breach_names.size}}"},"keep_events_for":604800},{"type":"Agents::HTTPRequestAgent","name":"Check Email Reputation in EmailRep.io","disabled":false,"guid":"eb1aaf2a18cbee5031dbf974e7b4eaef","options":{"url":"https://{% global_resource emailrepio %}/{{ .receive_webhook_from_send_to_story.email }}","content_type":"json","method":"get","payload":{},"headers":{"Key":"{% credential emailrepiokey %} ","User-Agent":"Tines Security Automation"}},"schedule":null,"keep_events_for":604800},{"type":"Agents::HTTPRequestAgent","name":"Update TheHive Case with Jira IDs","disabled":false,"guid":"72cf84a6bcab66d9a6f4e852d62e64a8","options":{"url":"http://{% global_resource thehive %}/api/case/{{ .create_case_in_thehive.body.id }}/task","content_type":"json","method":"post","payload":{"title":"Jira Details","description":"*Jira ID:* {{ .create_case_in_jira_service_desk.body.id }}  \n*Jira Key:* {{ .create_case_in_jira_service_desk.body.key }}  \n*Jira Link:* https://{% global_resource jirahost %}/browse/{{ .create_case_in_jira_service_desk.body.key }}   ","status":"Completed"},"headers":{"Authorization":"Bearer {% credential thehive %}"}},"schedule":null,"keep_events_for":604800},{"type":"Agents::HTTPRequestAgent","name":"Create Case in TheHive","disabled":false,"guid":"860ebbf79a27b2dcce24f7cdb6325659","options":{"url":"http://{% global_resource thehive %}/api/case","content_type":"json","method":"post","payload":{"title":"New Compromised Account Credentials","description":"*Global Incident ID:* {{ .global_incident_id.global_incident_id }}  \n*User/Email Account:* {{ .receive_webhook_from_send_to_story.email }}  \n*Email Malicious Activity:* {{ .check_email_reputation_in_emailrep_io.body.details.malicious_activity }}  (Recent: {{ .check_email_reputation_in_emailrep_io.body.details.malicious_activity_recent }} )  \n*Used For Spam:* {{ .check_email_reputation_in_emailrep_io.body.details.spam}}  \n  \n*BREACH SUMMARIES* {{ .summarize_breaches.breach_summaries }} ","severity":3,"tlp":2,"tags":["automatic","creation","compromise","account"]},"headers":{"Authorization":"Bearer {% credential thehive %}"}},"schedule":null,"keep_events_for":604800},{"type":"Agents::HTTPRequestAgent","name":"Create Case in Jira Service Desk","disabled":false,"guid":"025f8798228a81c8ae6deb33f55edc7e","options":{"url":"https://{% global_resource jirahost %}/rest/api/2/issue","content_type":"json","method":"post","payload":{"fields":{"project":{"key":"DESK"},"issuetype":{"name":"Incident"},"priority":{"name":"Highest"},"summary":"Security Issue : New Compromised Account Credentials","description":"*Global Incident ID:* {{ .global_incident_id.global_incident_id }}  \n*TheHive Case ID:* {{ .create_case_in_thehive.body.id }}  \n*User/Email Account:* {{ .receive_webhook_from_send_to_story.email }}   \n*Email Malicious Activity:* {{ .check_email_reputation_in_emailrep_io.body.details.malicious_activity }}  (Recent: {{ .check_email_reputation_in_emailrep_io.body.details.malicious_activity_recent }} )  \n*Used For Spam:* {{ .check_email_reputation_in_emailrep_io.body.details.spam }}  \n  \n*BREACH SUMMARIES* {{ .summarize_breaches.breach_summaries }}"}},"basic_auth":["{% global_resource jirausername %}","{% credential jira %}"]},"schedule":null,"keep_events_for":604800},{"type":"Agents::EventTransformationAgent","name":"Summarize Breaches","disabled":false,"guid":"686ce9ed3fd28915096c7da1bc11130f","options":{"mode":"message_only","breach_email":"{{ .receive_webhook_from_send_to_story.email }}","breach_summaries":"{% for element in implode_breach_details  %}\n{% assign domain = element.get_breach_details_in_have_i_been_pwned.body.Domain %}\n*Breach Name:* {{ element.get_breach_details_in_have_i_been_pwned.body.Name }}  \n*Breach Domain:* {% if domain == blank %} Not Breach Domain Specific {% else %}{{ domain }}{% endif %}  \n*Breach Date:* {{ element.get_breach_details_in_have_i_been_pwned.body.BreachDate }}  \n*Breach Description:* {{ element.get_breach_details_in_have_i_been_pwned.body.Description }}  \n*Data Classes:* {{ element.get_breach_details_in_have_i_been_pwned.body.DataClasses | neat_json }}  \n*Verified:* {{ element.get_breach_details_in_have_i_been_pwned.body.IsVerified }}  \n{% if forloop.last != true %}\n     \n{% endif %}\n{% endfor %}"},"keep_events_for":604800},{"type":"Agents::HTTPRequestAgent","name":"Get Breach Details in Have I Been Pwned","disabled":false,"guid":"09f18e7f144628d7497bbf3208f0f6fc","options":{"url":"https://{% global_resource haveibeenpwnedhost %}/api/v3/breach/{{ .explode_breach_names.breach_name.Name }}","content_type":"json","method":"get","headers":{"hibp-api-key":"{% credential haveibeenpwned %}","user-agent":"Tines Security Automation"}},"schedule":null,"keep_events_for":604800}],"links":[{"source":1,"receiver":3},{"source":2,"receiver":0},{"source":3,"receiver":13},{"source":5,"receiver":1},{"source":6,"receiver":10},{"source":7,"receiver":12},{"source":8,"receiver":6},{"source":10,"receiver":2},{"source":10,"receiver":11},{"source":11,"receiver":4},{"source":11,"receiver":9},{"source":12,"receiver":8},{"source":13,"receiver":7}],"diagram_layout":"{\"6aff3ecaecdf063a33278aed56574bb2\":[-300,-105],\"686ce9ed3fd28915096c7da1bc11130f\":[-300,255],\"09f18e7f144628d7497bbf3208f0f6fc\":[-300,105],\"ab1e31a2c725865e70530bc28f12a26b\":[-300,-15],\"3b53755c545c20257829e519c25cc9fd\":[-300,195],\"025f8798228a81c8ae6deb33f55edc7e\":[-300,570],\"c7887512e51a34294d3083ba74685f01\":[-90,645],\"860ebbf79a27b2dcce24f7cdb6325659\":[-300,495],\"500d3c1a4f77b8037fcada67723d7d5a\":[-300,435],\"7f1cc802f7c42b32983fbdf53f6decfb\":[-300,45],\"817744585c7245b4f4fee848c4601b2c\":[-90,570],\"eb1aaf2a18cbee5031dbf974e7b4eaef\":[-300,330],\"84d36ac2e029eb5599946a6d0ac57d82\":[-300,720],\"72cf84a6bcab66d9a6f4e852d62e64a8\":[-510,660]}","send_to_story_enabled":true,"entry_agent_guid":"6aff3ecaecdf063a33278aed56574bb2","exit_agent_guid":"84d36ac2e029eb5599946a6d0ac57d82","send_to_stories":[]}