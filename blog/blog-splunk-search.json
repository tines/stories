{"schema_version":3,"name":"Splunk Search","description":null,"guid":"dce28ed1f2893ee8fd19bdb4d9406719","exported_at":"2020-10-08T12:54:45Z","agents":[{"type":"Agents::HTTPRequestAgent","name":"Create Search in Splunk","disabled":false,"guid":"a6c27918b060f12633b6ee49be5f4060","options":{"url":"https://{% global_resource splunk %}/services/search/jobs","content_type":"form","method":"post","payload":{"search":"search host=* source=WinEventLog:Security EventCode={{ .receive_search_query.body.event_code.first | split: \":\" | first }} earliest=-{{ .receive_search_query.body.hours }}h","output_mode":"json","count":"{{ .receive_search_query.body.max_count.first | split: \":\" | first  }}"},"basic_auth":["{% global_resource splunk_username %}","{% credential splunk_password %}"],"disable_ssl_verification":"true","log_error_on_status":["400-499","500-599","0"]},"schedule":null,"keep_events_for":0},{"type":"Agents::TriggerAgent","name":"Search Complete","disabled":false,"guid":"9d10a0d9494caaac0c3c5a3e5d063c64","options":{"rules":[{"type":"regex","value":"DONE","path":"{{.get_search_status.body.entry[0].content.dispatchState}}"}]},"keep_events_for":0},{"type":"Agents::TriggerAgent","name":"Search Failed or was Paused","disabled":false,"guid":"b8e472c172578a6353ec3891253bb05e","options":{"rules":[{"type":"regex","value":"PAUSED|FAILED","path":"{{.get_search_status.body.entry[0].content.dispatchState}}"}]},"keep_events_for":0},{"type":"Agents::HTTPRequestAgent","name":"Get Search Status","disabled":false,"guid":"de05e433b164b206058feb44a10ec056","options":{"url":"https://{% global_resource splunk %}/services/search/jobs/{{.create_search_in_splunk.body.sid}}","content_type":"json","method":"get","disable_ssl_verification":"true","log_error_on_status":[],"payload":{"output_mode":"json"},"basic_auth":["{% global_resource splunk_username %}","{% credential splunk_password %}"]},"schedule":null,"keep_events_for":0},{"type":"Agents::TriggerAgent","name":"Search Incomplete","disabled":false,"guid":"cf52737b2f9a131a4f541059bd0e407a","options":{"rules":[{"type":"regex","value":"RUNNING|FINALIZING|PARSING","path":"{{.get_search_status.body.entry[0].content.dispatchState}}"}]},"keep_events_for":0},{"type":"Agents::HTTPRequestAgent","name":"Get Search Results","disabled":false,"guid":"970a2b43b225fa28aa34227c9cce6f48","options":{"url":"https://{% global_resource splunk %}/services/search/jobs/{{.create_search_in_splunk.body.sid}}/events","content_type":"json","method":"get","disable_ssl_verification":"true","log_error_on_status":[],"payload":{"output_mode":"json","count":"{{ .receive_search_query.body.count}}"},"basic_auth":["{% global_resource splunk_username %}","{% credential splunk_password %}"]},"schedule":null,"keep_events_for":0},{"type":"Agents::EventTransformationAgent","name":"Delay Before Retry","disabled":false,"guid":"f7c81f5cce34cf7ee93cc97f4d5ea7e3","options":{"mode":"delay","seconds":"5"},"keep_events_for":0},{"type":"Agents::WebhookAgent","name":"Receive Search Query","disabled":false,"guid":"0e304af5dd24fe180156c9fd9f0e7af3","options":{"secret":"910392932d11e7dc01ecc58bfd9c7b88","verbs":"get,post"},"keep_events_for":0},{"type":"Agents::TriggerAgent","name":"Search Created OK","disabled":false,"guid":"aeb223594c55d9eb781c4765f2d05862","options":{"rules":[{"type":"field==value","path":"{{ .create_search_in_splunk.status }}","value":"201"}]},"keep_events_for":0},{"type":"Agents::TriggerAgent","name":"Search Problems","disabled":false,"guid":"1f7a8c8dd5d9e81b9af08b37b658a7e0","options":{"rules":[{"type":"field!=value","value":"201","path":"{{ .create_search_in_splunk.status }}"}]},"keep_events_for":0},{"type":"Agents::EmailAgent","name":"Email Requester with Error","disabled":false,"guid":"5edfd19f5b5c88381a023cdc8034e2e2","options":{"recipients":"{{ .receive_search_query.body.email}}","subject":"Problem with Canned Splunk Search","body":"Search ID: {{.create_search_in_splunk.body.sid}} {% line_break %} {{ .create_search_in_splunk.body.messages}}"},"keep_events_for":0},{"type":"Agents::EmailAgent","name":"Email Requester with Results","disabled":false,"guid":"2b67248da228017ceef0a13c7af6a903","options":{"recipients":"{{ .receive_search_query.body.email}}","subject":"Results from Canned Splunk Search","body":"Your reminder note: {{ .receive_search_query.body.note }} \n\nPlease see attached results.","attachments":[{"filename":"splunk_search_for_{{ .receive_search_query.body.event_code.first | split: \":\" | first}}_sid_{{ .create_search_in_splunk.body.sid}}.txt","base64encodedcontents":"{{ .build_report.build_csv}}","content_type":"text/plain"}]},"keep_events_for":0},{"type":"Agents::EventTransformationAgent","name":"Build Report","disabled":false,"guid":"d95ec6fd3f4c58e311e9cf787f6de57e","options":{"mode":"message_only","build_csv":"{% capture results %}{% for element in .get_search_results.body.results %}{{ element.index }},{{ element.host }},{{ element.EventCode}},{{ element.sourcetype}},{{ element.source}},{{element.Message | regex_replace: \"\\r\\n\", \",\" | regex_replace: \"\\t\", \" \" }}{% if forloop.last != true %}{% line_break %}{% endif %}{% endfor %}{% endcapture %}\n{{ results | base64_encode }}","results_size":"{{ .get_search_results.body.results.size }}"},"keep_events_for":0},{"type":"Agents::EventTransformationAgent","name":"Return Report","disabled":false,"guid":"bb1d81bcda037f51fed60ce70d26a7a7","options":{"mode":"message_only","build_csv":"{{ .build_report.build_csv }}","results_size":"{{ .get_search_results.body.results.size }}"},"keep_events_for":0},{"type":"Agents::EmailAgent","name":"Email Requester with State","disabled":false,"guid":"5b998793c231ae962e3b1dc7fa860e3e","options":{"recipients":"{{ .receive_search_query.body.email}}","subject":"Problem with Canned Splunk Search","body":"Search ID: {{.create_search_in_splunk.body.sid}} {% line_break %} {{.get_search_status.body.entry[0].content.dispatchState}}"},"keep_events_for":0}],"links":[{"source":0,"receiver":8},{"source":0,"receiver":9},{"source":1,"receiver":5},{"source":2,"receiver":14},{"source":3,"receiver":4},{"source":3,"receiver":1},{"source":3,"receiver":2},{"source":4,"receiver":6},{"source":5,"receiver":12},{"source":6,"receiver":3},{"source":7,"receiver":0},{"source":8,"receiver":3},{"source":9,"receiver":10},{"source":12,"receiver":11},{"source":12,"receiver":13}],"diagram_layout":"{\"a6c27918b060f12633b6ee49be5f4060\":[45,270],\"de05e433b164b206058feb44a10ec056\":[45,450],\"cf52737b2f9a131a4f541059bd0e407a\":[-180,540],\"9d10a0d9494caaac0c3c5a3e5d063c64\":[45,540],\"f7c81f5cce34cf7ee93cc97f4d5ea7e3\":[-180,600],\"970a2b43b225fa28aa34227c9cce6f48\":[45,645],\"b8e472c172578a6353ec3891253bb05e\":[270,540],\"0e304af5dd24fe180156c9fd9f0e7af3\":[45,210],\"aeb223594c55d9eb781c4765f2d05862\":[45,375],\"1f7a8c8dd5d9e81b9af08b37b658a7e0\":[270,375],\"5edfd19f5b5c88381a023cdc8034e2e2\":[270,450],\"2b67248da228017ceef0a13c7af6a903\":[270,780],\"d95ec6fd3f4c58e311e9cf787f6de57e\":[45,705],\"bb1d81bcda037f51fed60ce70d26a7a7\":[45,780],\"5b998793c231ae962e3b1dc7fa860e3e\":[270,615]}","send_to_story_enabled":true,"entry_agent_guid":"0e304af5dd24fe180156c9fd9f0e7af3","exit_agent_guid":"bb1d81bcda037f51fed60ce70d26a7a7","send_to_stories":[],"form":{"name":"Windows Quick Threat Hunt","description":"This interface provides a rapid and pre-defined canned search for Windows events in the past without having to bestow Splunk account access.","fields":[{"name":"Event Code","description":"Choice of Event Codes to hunt for...","required":true,"type":"OPTION","multi_select":false,"options":["4688: A New process has been created","4738: A user account was changed","4624: An account was successfully logged on","1102: The audit log was cleared","4719: System audit policy was changed"],"ranking":0,"max_characters":null},{"name":"Hours","description":"How far to perform the look back in time i.e. from 1 hour ago to now or 2 days ago to now.","required":true,"type":"OPTION","multi_select":false,"options":["1","2","4","8","24","48"],"ranking":1073741824,"max_characters":null},{"name":"Email","description":"Email to send results of report to","required":true,"type":"EMAIL","multi_select":false,"options":["Option 1","Option 2"],"ranking":1879048192,"max_characters":null},{"name":"Note","description":"(Optional) Any label, tag, or ID that this search might relate to such as a Jira or Hive issue or case.","required":false,"type":"SHORT_TEXT","multi_select":false,"options":["Option 1","Option 2"],"ranking":536870912,"max_characters":null},{"name":"Max Count","description":"Maximum count of results to retrieve","required":true,"type":"OPTION","multi_select":false,"options":["0: Unlimited Events","10: Events","100: Events","1000: Events"],"ranking":1342177280,"max_characters":null}],"visibility":"tenant","agent_guid":"0e304af5dd24fe180156c9fd9f0e7af3","enabled":false,"success_message":"Thank you for your submission"}}