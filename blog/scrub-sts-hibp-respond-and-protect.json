{"schema_version":1,"name":"Scrub STS HIBP Respond and Protect","description":null,"guid":"cee50d89e09a5e425fc498bf37599f0e","exported_at":"2020-07-31T09:36:18Z","agents":[{"type":"Agents::HTTPRequestAgent","name":"Send User a Slack Message with Prompts for Confirmation","disabled":false,"guid":"92affebf0d857569a23104c31b133cad","options":{"url":"https://slack.com/api/chat.postMessage","content_type":"json","method":"post","payload":{"channel":"{{.search_slack_users_by_email.body.user.id}}","attachments":[{"blocks":[{"type":"section","fields":[{"type":"mrkdwn","text":"*What's happening?*{% line_break %} We are resetting your main work account and have temporarily locked you out of email and some other business applications.{% line_break %}"},{"type":"mrkdwn","text":"*Why?*{% line_break %} Some of your work account details have been involved in a security incident."},{"type":"mrkdwn","text":"*What must I do?*{% line_break %} Firstly, please click the button below to acknowledge this message and you will be contacted directly by the Helpdesk.{% line_break %}"},{"type":"mrkdwn","text":"*Reference*{% line_break %} Please quote this reference ID in any dealings with Helpdesk or Security Teams: \"*{{ .receive_webhook_from_send_to_story.global_incident_id }}*\"{% line_break %}"}]},{"type":"actions","elements":[{"type":"button","text":{"type":"plain_text","emoji":true,"text":"[Required] Yes, I understand âœ…"},"style":"primary","url":"{% prompt true %}"}]}]}],"text":"We have detected a security incident related to your work account or business access. We have temporarily logged you out of email and other primary productivity applications. Please click the button to acknowledge you understand so we can have Helpdesk contact you immediately with an update."},"headers":{"Authorization":"Bearer {% credential slack %}"}},"schedule":null,"keep_events_for":604800},{"type":"Agents::HTTPRequestAgent","name":"Send Helpdesk Channel a Notification of Lockouts","disabled":false,"guid":"ee2266fbd812006e900c12805a549463","options":{"url":"https://slack.com/api/chat.postMessage","content_type":"json","method":"post","payload":{"channel":"{% global_resource slackhelpdeskchannelid %}","attachments":[{"blocks":[{"type":"section","fields":[{"type":"mrkdwn","text":"*Priority Security Event*{% line_break %} Account {{ .receive_webhook_from_send_to_story.breach_email}} has been locked out due to an ongoing incident. More details in Jira Case: https://{% global_resource jirahost %}/browse/{{ .receive_webhook_from_send_to_story.jira_key }}{% line_break %} where you will also find the Global Incident ID: \"*{{ .receive_webhook_from_send_to_story.global_incident_id }}*\""}]}]}],"text":"We have detected a security incident related to compromised account details."},"headers":{"Authorization":"Bearer {% credential slack %}"}},"schedule":null,"keep_events_for":604800},{"type":"Agents::EventTransformationAgent","name":"Wait For Completion","disabled":false,"guid":"a115a947934da76f0bf8047ad151eeaf","options":{"mode":"implode","guid_path":"{% story_run_guid %}","size_path":"3"},"keep_events_for":604800},{"type":"Agents::HTTPRequestAgent","name":"Update TheHive Case with User Acknowledgement","disabled":false,"guid":"0afeb1eb0481eff475144758c634d716","options":{"url":"http://{% global_resource thehive %}/api/case/{{ .receive_webhook_from_send_to_story.thehive_id }}/task","content_type":"json","method":"post","payload":{"title":"User ACK Confirmed","description":"User: {{ .receive_webhook_from_send_to_story.breach_email }} has acknowledged the incident via Slack.  ","status":"Completed"},"headers":{"Authorization":"Bearer {% credential thehive %}"}},"schedule":null,"keep_events_for":604800},{"type":"Agents::HTTPRequestAgent","name":"Update Jira Case with User Acknowledgement","disabled":false,"guid":"5d10c783ca898d26446c7140c9d226c0","options":{"url":"https://{% global_resource jirahost %}/rest/api/2/issue/{{ receive_webhook_from_send_to_story.jira_id }}/comment/","content_type":"json","method":"post","basic_auth":["{% global_resource jirausername %}","{% credential jira %}"],"payload":{"body":"User: {{ .receive_webhook_from_send_to_story.breach_email }} has acknowledged the incident via Slack."}},"schedule":null,"keep_events_for":604800},{"type":"Agents::TriggerAgent","name":"Trigger When User Clicks Slack Prompt","disabled":false,"guid":"be8fd192b3bff3132a17d76272123ea9","options":{"rules":[{"type":"regex","value":"true","path":"{{ .send_user_a_slack_message_with_prompts_for_confirmation.prompt }}"}]},"keep_events_for":604800},{"type":"Agents::EventTransformationAgent","name":"Build Results","disabled":false,"guid":"bfa5359f7ef0a47093eb4e0caea5122a","options":{"mode":"message_only","message":"Notifications Sent. User Acknowledged. Case Management updated.","global_incident_id":"{{ receive_webhook_from_send_to_story.global_incident_id }}"},"keep_events_for":604800},{"type":"Agents::WebhookAgent","name":"Receive Webhook from Send To Story","disabled":false,"guid":"9c77e452f0f06b9f805e3026b2b65f1e","options":{"secret":"91d9ccad96bf3575ab1add5ee03a4dc7","verbs":"get,post"},"keep_events_for":604800},{"type":"Agents::HTTPRequestAgent","name":"Disable and Log Out User Account in MSGraph Office 365","disabled":false,"guid":"ed495416fac31908da800d25353067c1","options":{"url":"https://graph.microsoft.com/v1.0/users/{{ .receive_webhook_from_send_to_story.breach_email }} ","method":"patch","content_type":"json","payload":{"accountEnabled":false},"headers":{"Authorization":"Bearer {% credential msgraph %}"}},"schedule":null,"keep_events_for":604800},{"type":"Agents::TriggerAgent","name":"Trigger On Lockout Success","disabled":false,"guid":"b247fcbf011268e2a4312561ffb65bf7","options":{"rules":[{"type":"field==value","value":"204","path":"{{ .disable_and_log_out_user_account_in_msgraph_office_365.status}}"}]},"keep_events_for":604800},{"type":"Agents::HTTPRequestAgent","name":"Search Slack Users by Email","disabled":false,"guid":"ef2ac5d37490b1f3b5c7a49ef5a02c0c","options":{"url":"https://slack.com/api/users.lookupByEmail","content_type":"json","method":"get","payload":{"email":"{{ .receive_webhook_from_send_to_story.breach_email }}"},"headers":{"Authorization":"Bearer {% credential slack %}"}},"schedule":null,"keep_events_for":604800}],"links":[{"source":0,"receiver":5},{"source":1,"receiver":2},{"source":2,"receiver":6},{"source":3,"receiver":2},{"source":4,"receiver":2},{"source":5,"receiver":4},{"source":5,"receiver":3},{"source":7,"receiver":8},{"source":8,"receiver":9},{"source":9,"receiver":10},{"source":9,"receiver":1},{"source":10,"receiver":0}],"diagram_layout":"{\"9c77e452f0f06b9f805e3026b2b65f1e\":[-375,60],\"bfa5359f7ef0a47093eb4e0caea5122a\":[-225,825],\"ed495416fac31908da800d25353067c1\":[-375,150],\"92affebf0d857569a23104c31b133cad\":[-510,420],\"ef2ac5d37490b1f3b5c7a49ef5a02c0c\":[-510,345],\"be8fd192b3bff3132a17d76272123ea9\":[-510,510],\"b247fcbf011268e2a4312561ffb65bf7\":[-375,240],\"0afeb1eb0481eff475144758c634d716\":[-645,600],\"5d10c783ca898d26446c7140c9d226c0\":[-420,600],\"ee2266fbd812006e900c12805a549463\":[-225,345],\"a115a947934da76f0bf8047ad151eeaf\":[-225,750]}","send_to_story_enabled":null,"entry_agent_guid":null,"exit_agent_guid":null,"send_to_stories":[]}